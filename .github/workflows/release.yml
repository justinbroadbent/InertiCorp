name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

env:
  DOTNET_CLI_TELEMETRY_OPTOUT: true
  DOTNET_NOLOGO: true
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Restore dependencies
        run: dotnet restore

      - name: Build
        run: dotnet build --configuration Release --no-restore

      - name: Test
        run: dotnet test --configuration Release --no-build --verbosity normal

  build-windows:
    name: Build Windows Release
    needs: test
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Setup Godot
        uses: chickensoft-games/setup-godot@v2
        with:
          version: 4.5.1
          use-dotnet: true
          include-templates: true

      - name: Restore dependencies
        run: dotnet restore

      - name: Debug Godot environment
        run: |
          Write-Host "GODOT env var: $env:GODOT"
          Write-Host "GODOT4 env var: $env:GODOT4"
          Write-Host ""
          Write-Host "=== Bin directory contents ==="
          Get-ChildItem "C:\Users\runneradmin\bin" | Format-Table Name, Length, Mode
          Write-Host ""
          Write-Host "=== Checking different extensions ==="
          $paths = @("$env:GODOT", "$env:GODOT.exe", "$env:GODOT.cmd", "$env:GODOT.bat")
          foreach ($p in $paths) {
            if (Test-Path $p) {
              Write-Host "EXISTS: $p"
            } else {
              Write-Host "MISSING: $p"
            }
          }
          Write-Host ""
          Write-Host "=== Testing execution ==="
          Write-Host "Trying: & `"$env:GODOT`" --version"
          $result = & "$env:GODOT" --version 2>&1
          Write-Host "Result: $result"
          Write-Host "Exit code: $LASTEXITCODE"
          Write-Host ""
          Write-Host "Trying with .exe:"
          if (Test-Path "$env:GODOT.exe") {
            $result2 = & "$env:GODOT.exe" --version 2>&1
            Write-Host "Result: $result2"
            Write-Host "Exit code: $LASTEXITCODE"
          }
          Write-Host ""
          Write-Host "Trying cmd.exe /c:"
          $result3 = cmd.exe /c "$env:GODOT --version" 2>&1
          Write-Host "Result: $result3"
        shell: pwsh

      - name: Generate .NET bindings
        run: |
          & $env:GODOT --headless --path src/InertiCorp.Game --build-solutions --quit
        shell: pwsh
        continue-on-error: true

      - name: Build .NET project
        run: dotnet build --configuration Release

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
        shell: bash

      - name: Create build directory
        run: New-Item -ItemType Directory -Force -Path build
        shell: pwsh

      - name: Export Game
        run: |
          $godot = $env:GODOT
          Write-Host "Using Godot binary: $godot"
          Write-Host "Godot version:"
          & $godot --version
          Write-Host "Starting export to: ${{ github.workspace }}\build\InertiCorp.exe"
          & $godot --headless --verbose --path src/InertiCorp.Game --export-release "Windows Desktop" "${{ github.workspace }}\build\InertiCorp.exe" 2>&1
          $exitCode = $LASTEXITCODE
          Write-Host "Export completed with exit code: $exitCode"
          if ($exitCode -ne 0) {
            Write-Host "Export may have failed!"
          }
        shell: pwsh
        continue-on-error: true

      - name: List build directory
        run: |
          Write-Host "Build directory contents:"
          if (Test-Path "build") {
            Get-ChildItem build -Recurse | Select-Object FullName, Length | Format-Table -AutoSize
          } else {
            Write-Host "Build directory does not exist!"
          }
        shell: pwsh

      - name: Verify export succeeded
        run: |
          if (!(Test-Path "build\InertiCorp.exe")) {
            Write-Error "Export failed - InertiCorp.exe not found. Check export step output above."
            exit 1
          }
          Write-Host "Export succeeded! File count:"
          (Get-ChildItem build -Recurse).Count
        shell: pwsh

      - name: Create ZIP archive
        run: |
          Compress-Archive -Path build\* -DestinationPath "InertiCorp-${{ steps.version.outputs.VERSION }}-Windows.zip"
        shell: pwsh

      - name: Install Inno Setup
        run: choco install innosetup -y

      - name: Update version in installer script
        run: |
          $content = Get-Content installer/InertiCorp.iss -Raw
          $content = $content -replace '#define MyAppVersion ".*"', '#define MyAppVersion "${{ steps.version.outputs.VERSION }}"'
          Set-Content installer/InertiCorp.iss $content
        shell: pwsh

      - name: Build Installer
        run: |
          # Update source path to use absolute path
          $issContent = Get-Content installer/InertiCorp.iss -Raw
          $issContent = $issContent -replace 'Source: "\.\.\\build\\\*"', "Source: `"${{ github.workspace }}\build\*`""
          Set-Content installer/InertiCorp.iss $issContent
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" /O"." /F"InertiCorp-${{ steps.version.outputs.VERSION }}-Setup" installer/InertiCorp.iss
        shell: pwsh

      - name: Upload Release Assets
        uses: softprops/action-gh-release@v1
        with:
          files: |
            InertiCorp-${{ steps.version.outputs.VERSION }}-Windows.zip
            InertiCorp-${{ steps.version.outputs.VERSION }}-Setup.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-linux:
    name: Build Linux Release
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Setup Godot
        uses: chickensoft-games/setup-godot@v2
        with:
          version: 4.5.1
          use-dotnet: true
          include-templates: true

      - name: Restore dependencies
        run: dotnet restore

      - name: Generate .NET bindings
        run: godot --headless --path src/InertiCorp.Game --build-solutions --quit || true

      - name: Build .NET project
        run: dotnet build --configuration Release

      - name: Create build directory
        run: mkdir -p build

      - name: Export Game
        run: godot --headless --path src/InertiCorp.Game --export-release "Linux" "../../build/InertiCorp.x86_64"

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Create tarball
        run: |
          cd build
          tar -czvf "../InertiCorp-${{ steps.version.outputs.VERSION }}-Linux.tar.gz" *

      - name: Upload Release Asset
        uses: softprops/action-gh-release@v1
        with:
          files: InertiCorp-${{ steps.version.outputs.VERSION }}-Linux.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
